# ServSync CI/CD
#
# What this does:
# - Validate: On every push and PR, installs deps and runs `cdk synth` to ensure the
#   AWS stack (Lambda, Step Functions, API Gateway, etc.) compiles and has no config errors.
# - Deploy: On push to main only, runs `cdk deploy` so the live stack is updated automatically.
#   No need to run "cd infra && cdk deploy" from your laptop—push code and the pipeline deploys it.
#
# Required: In GitHub repo Settings → Secrets and variables → Actions, add:
#   AWS_ACCESS_KEY_ID, AWS_SECRET_ACCESS_KEY (from an IAM user with CDK deploy permissions).
#   Optional: AWS_REGION (defaults to us-east-1).

name: CI/CD

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  validate:
    name: Validate (synth)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install root dependencies
        run: npm ci
        working-directory: .

      - name: Install infra dependencies
        run: npm ci
        working-directory: infra

      - name: CDK synth
        run: npx cdk synth --no-version-reporting
        working-directory: infra

  deploy:
    name: Deploy to AWS
    runs-on: ubuntu-latest
    needs: validate
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install root dependencies
        run: npm ci
        working-directory: .

      - name: Install infra dependencies
        run: npm ci
        working-directory: infra

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION || 'us-east-1' }}

      - name: CDK deploy
        run: npx cdk deploy --require-approval never --no-version-reporting
        working-directory: infra
